{"version":3,"file":"notif.min.js","sources":["../src/notif.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manager for the coursefeedback blocks rankingpage (ranking.php).\n *\n * @module      block_coursefeedback\n * @copyright  2023 innoCampus, Technische UniversitÃ¤t Berlin\n * @author     2011-2023 onwards Jan Eberhardt\n * @author     2022 onwards Felix Di Lenarda\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport * as Str from 'core/str';\n\n// Initiate the needed  global vars.\nconst CFB_QUESTIONTYPE_SCHOOLGRADE = 1;\nconst CFB_QUESTIONTYPE_ESSAY = 2;\nlet courseId;\nlet feedbackId;\nlet questionId;\nlet questionType;\nlet questionSum;\nlet textarea;\nlet sendingActive = false;\nlet essayContainer;\nlet schoolgradesContainer;\n\n/**\n * FadeOut element\n * @param {Object} element\n * @returns {Promise}\n */\nfunction fadeOut(element) {\n    return new Promise((resolve) => {\n        let opacity = parseFloat(window.getComputedStyle(element).getPropertyValue(\"opacity\"));\n        // Fallback if opacity isn't computed properly.\n        if (isNaN(opacity)) {\n            opacity = 0;\n        }\n        let fadingOut = setInterval(function () {\n            if (opacity <= 0) {\n                clearInterval(fadingOut);\n                resolve();\n            } else {\n                opacity = opacity - 0.1;\n                element.style.opacity = opacity;\n            }\n        }, 50);\n    });\n}\n\n/**\n * FadeIn element\n *\n * @param {Object} element\n */\nfunction fadeIn(element) {\n    let opacity = parseFloat(window.getComputedStyle(element).getPropertyValue(\"opacity\"));\n    // Fallback if opacity isn't computed properly.\n    if (isNaN(opacity)) {\n        opacity = 0;\n    }\n    let fadingIn = setInterval(function() {\n        if (opacity >= 1) {\n            clearInterval(fadingIn);\n        } else {\n            opacity = opacity + 0.1;\n            element.style.opacity = opacity;\n        }\n    }, 50);\n}\n\n/**\n * Send and receive feedback after answer was given\n *\n * @param {number} feedback (given schoolgrade answer)\n * @param {text} essay (given essay answer)\n */\nconst sendAndReceiveFeedback = (feedback, essay) => {\n    // Prevent doubleclicking for the same question.\n    if (sendingActive == true) {\n        return;\n    } else {\n        sendingActive = true;\n    }\n\n    // Get needed elements/nodes.\n    let notifikations = document.getElementById(\"user-notifications\");\n    let feedbackNotif = notifikations.getElementsByClassName(\"cfb-notification-container\")[0];\n    let questionInfo = notifikations.getElementsByClassName(\"cfb-question-info\")[0];\n    let question = notifikations.getElementsByClassName(\"cfb-question\")[0];\n    let notif = feedbackNotif.parentElement;\n\n    // Fading out notification after clicking an emoji.\n    let foPromise = fadeOut(notif);\n\n    // Submit given FB to the server and receive new question if any left.\n    let promises = Ajax.call([{\n        methodname: 'block_coursefeedback_answer_question_and_get_new',\n        args: {\n            courseid: courseId,\n            feedback: feedback,\n            essay: essay,\n            feedbackid: feedbackId,\n            questionid: questionId,\n        }\n    }]);\n    promises[0].done(function (data) {\n        // Put new notification content and fade in after fadingout-promise resolved.\n        foPromise.then(() => {\n            if (data.nextquestion === null) {\n                // All questions were answered (no following question).\n                let thanksString = Str.get_string('notif_thankyou', 'block_coursefeedback');\n                thanksString.done(function (string) {\n                    feedbackNotif.innerHTML = string;\n                    fadeIn(notif);\n                });\n            } else {\n                // A following question was returned.\n                questionId = data.nextquestionid;\n                // Delete textarea value.\n                textarea.value = '';\n                // Check if we need to swap questiontypes.\n                let nextQuestionType = data.nextquestiontype;\n                if (questionType !== nextQuestionType) {\n                    // Choose which questiontype needs to be visible.\n                    if (nextQuestionType === CFB_QUESTIONTYPE_SCHOOLGRADE) {\n                        schoolgradesContainer.classList.remove('d-none');\n                        essayContainer.classList.add('d-none');\n                    } else if (nextQuestionType === CFB_QUESTIONTYPE_ESSAY) {\n                        schoolgradesContainer.classList.add('d-none');\n                        essayContainer.classList.remove('d-none');\n                    }\n                    // Update current questiontype.\n                    questionType = nextQuestionType;\n                }\n                // Update questionInfo and question and show.\n                let qStr = Str.get_string('notif_question', 'block_coursefeedback');\n                qStr.done(function(string) {\n                    questionInfo.innerHTML = string.concat(questionId).concat('/').concat(questionSum).concat(': ');\n                    question.innerHTML = data.nextquestion;\n                    sendingActive = false;\n                    fadeIn(notif);\n                });\n            }\n        });\n    }).fail(function(ex) {\n        window.console.error(ex);\n    });\n};\n\n/**\n * Initialise by activatin the emoji click listeners\n *\n * @param {number} cid courseId\n * @param {number} fbid feedbackId\n * @param {number} quid questionId\n * @param {number} qutype questionType\n * @param {number} qusum how many question in total in this FB\n */\nexport const initialise = (cid, fbid, quid, qutype, qusum) => {\n    // Set global vars.\n    courseId = cid;\n    feedbackId = fbid;\n    questionId = quid;\n    questionType = qutype;\n    questionSum = qusum;\n\n    let notifikations = document.getElementById(\"user-notifications\");\n    let feedbackNotif = notifikations.getElementsByClassName(\"cfb-notification-container\")[0];\n\n    // To prevent the destruction of our click events from bootsrap.\n    // We need to remove the 'role' attribute from this notification.\n    feedbackNotif.parentElement.removeAttribute(\"role\");\n\n    // Add click listener to our fbemoji-buttons for potential schoolgrade type questions.\n    const emojis = [...notifikations.getElementsByClassName(\"cfb-fbemoji\")];\n    emojis.map((emoji) => {\n        let answer = emojis.indexOf(emoji) + 1;\n        emoji.onclick = () => {\n            sendAndReceiveFeedback(answer, null);\n        };\n    });\n\n    // Add click listener to our essaysendbtn-button for potential essay type questions.\n    let div = document.getElementsByClassName('cfb-essaytextarea')[0];\n    textarea = document.createElement('textarea');\n    textarea.classList.add('w-100', 'rounded');\n    textarea.id = 'cfb-essay-textarea';\n    div.appendChild(textarea);\n    let sendButton = document.getElementsByClassName('cfb-essaysendbtn')[0];\n    sendButton.onclick = () => {\n        let essayanswer = textarea.value;\n        sendAndReceiveFeedback(null, essayanswer,);\n    };\n\n    // Bootstrap 4 does not have opacity classes, inline styles are filtered out for some reason.\n    // Therefore we use invisible class and then switch to opacity to fade in.\n    let overlayIcon = notifikations.getElementsByClassName(\"cfb-overlay-icon\")[0];\n\n    // Choose which questiontype needs to be visible.\n    schoolgradesContainer = notifikations.getElementsByClassName(\"cfb-schoolgrades-containaer\")[0];\n    essayContainer = notifikations.getElementsByClassName(\"cfb-essay-containaer\")[0];\n    let buttonContainer;\n    if (questionType == CFB_QUESTIONTYPE_SCHOOLGRADE) {\n        buttonContainer = schoolgradesContainer;\n        buttonContainer.style.opacity = 0;\n        buttonContainer.classList.remove('d-none');\n    } else if (questionType == CFB_QUESTIONTYPE_ESSAY) {\n        buttonContainer = essayContainer;\n        buttonContainer.style.opacity = 0;\n        buttonContainer.classList.remove('d-none');\n    }\n    // Fade out the loadingspinner and fade in the fbemoji-buttons.\n    let foPromise = fadeOut(overlayIcon);\n    foPromise.then(() => {\n        fadeIn(buttonContainer);\n    });\n};\n\n"],"names":["courseId","feedbackId","questionId","questionType","questionSum","textarea","essayContainer","schoolgradesContainer","sendingActive","fadeOut","element","Promise","resolve","opacity","parseFloat","window","getComputedStyle","getPropertyValue","isNaN","fadingOut","setInterval","clearInterval","style","fadeIn","fadingIn","sendAndReceiveFeedback","feedback","essay","notifikations","document","getElementById","feedbackNotif","getElementsByClassName","questionInfo","question","notif","parentElement","foPromise","Ajax","call","methodname","args","courseid","feedbackid","questionid","done","data","then","nextquestion","Str","get_string","string","innerHTML","nextquestionid","value","nextQuestionType","nextquestiontype","classList","remove","add","concat","fail","ex","console","error","cid","fbid","quid","qutype","qusum","removeAttribute","emojis","map","emoji","answer","indexOf","onclick","div","createElement","id","appendChild","essayanswer","buttonContainer","overlayIcon"],"mappings":"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"}